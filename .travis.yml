dist: xenial

branches:
  only:
    - master
    - /.*-runci$/

matrix:
  include:
    - language: ruby

      rvm: 2.6.2

      cache:
        directories:
          - ./server/vendor/bundle
      services:
        - postgresql

      before_install:
        - sudo apt-get install -y libidn11-dev imagemagick

      install:
        - cd server
        - bundle install --jobs=4 --retry=3 --path vendor/bundle

      before_script:
        - pwd
        - cd server
        - cp config/travis.database.yml config/database.yml
        - bundle exec rake db:create db:schema:load

      script:
        - bundle exec rake spec
        - bundle exec rubocop

    - language: node_js

      node_js: 10.15.3

      cache:
        directories:
          - ./web/node_modules

      install:
        - cd web
        - yarn install

      script:
        - cd web
        - yarn eslint
        - yarn stylelint
        - yarn testci
